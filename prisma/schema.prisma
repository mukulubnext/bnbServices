// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                    Int         @id @default(autoincrement())
  email                 String      @unique
  password              String    
  phone                 String      @unique
  firebaseId            String      @default("")

  isEmailVerified       Boolean     @default(false)
  isPhoneVerified       Boolean     @default(false)

  role                  String
  sellerType            String?

  companyName           String?
  address               String?
  city                  String?
  state                 String?
  zipCode               String?
  inceptionDate         DateTime?
  employeeCount         String?
  
  pastLegalAction       Boolean?     @default(false)
  pastLegalExplanation  String?

  isVerified            Boolean     @default(true)

  gstNumber             String?     @unique
  
  interestedCategories  Category[]
  interestedSubCategories SubCategory[]
  companyWebsite        String?
  
  posts                 Posts[]   
  offers                Offers[]
  transactions          Transaction[]

  credits               Int         @default(0)
  payments              Payment[]
  
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
}

model Payment {
  id                  String         @id @default(cuid()) @unique
  userId              Int
  user                User           @relation(fields: [userId], references: [id])
  amount              Decimal
  credits             Int            @default(0)
  provider            String
  providerOrderId     String         @unique
  transactionId       Int            @unique
  transaction         Transaction    @relation(fields: [transactionId], references: [id])
  status              PaymentStatus
  createdAt           DateTime       @default(now())
}

enum PaymentStatus{
  PENDING
  SUCCESS
  FAILED
}

model Posts {
  id                  Int         @id @default(autoincrement()) @unique
  title               String
  description         String?

  items               Item[]

  userId              Int
  user                User        @relation(fields: [userId], references: [id])
  offers              Offers[]
  clicks              Int[]       @default([])

  price               Int

  isActive            Boolean     @default(true)
  isFullfilled        Boolean     @default(false)

  isDeleted           Boolean?    @default(false)
  deletedAt           DateTime?
  deleteReason        String?
  
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
} 

model Category{
  id                  Int         @id @default(autoincrement())
  name                String      @unique

  users               User[]
  items               Item[]

  subCategories       SubCategory[]

  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
}
model SubCategory{
  id                  Int         @id @default(autoincrement())

  categoryId          Int
  category            Category    @relation(fields: [categoryId], references: [id])

  name                String
  items               Item[]

  users               User[]

  @@unique([categoryId, name])
}
model Offers{
  id                  Int         @id @default(autoincrement())

  postId              Int       
  post                Posts       @relation(fields: [postId], references: [id])

  userId              Int   
  user                User        @relation(fields: [userId], references: [id])

  transactionId       Int         @unique
  transaction         Transaction @relation(fields: [transactionId], references: [id])

  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  isDeleted           Boolean?    @default(false)
  deletedAt           DateTime?
}
model Item{
  id                  Int           @id @default(autoincrement())

  categoryId          Int
  category            Category      @relation(fields: [categoryId], references: [id])

  subCategoryId       Int?  
  subCategory         SubCategory?  @relation(fields: [subCategoryId], references: [id])

  details             String?
  units               Int           @default(1)

  quantity            Int           @default(0)
  quantityUnit        QuantityUnit  @default(L)

  budget              Decimal
  
  postId              Int
  post                Posts         @relation(fields: [postId], references: [id])

  isDeleted           Boolean?      @default(false)
  deletedAt           DateTime?

  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt @default(now())
}
model OTP {
  id            Int        @id @default(autoincrement())
  identifier    String     // email OR phone
  channel       OTPChannel
  purpose       OTPPurpose
  otpHash       String
  attemptsLeft  Int        @default(5)
  expiresAt     DateTime
  createdAt     DateTime   @default(now())

  @@index([identifier, channel, purpose])
}
model Credits{
  id            Int        @id @default(autoincrement())
  credits       Int
  price         Decimal
  isActive      Boolean    @default(true)
  @@unique([credits, price])
}

model Transaction{
  id            Int        @id @default(autoincrement())
  credits       Int
  userId        Int
  user          User       @relation(fields: [userId], references: [id])

  offer         Offers?   
  payment       Payment?

  type          TransactionType
  createdAt     DateTime   @default(now())
}

enum TransactionType {
  BUY
  OFFER
  SIGNUP_BONUS
}

enum OTPChannel {
  EMAIL
  PHONE
}

enum OTPPurpose {
  LOGIN
  SIGNUP
  RESET_PASSWORD
}
enum QuantityUnit{
  kg
  g
  L
  mL
  mm
  m
  cm
  gsm
}
